## 移动端网站



## 项目地址

https://wx.zsxq.com/dweb2/index/topic_detail/812842822424212

https://bcdh.yuque.com/staff-wpxfif/resource/co4pu1

## 前端

vue3 + vantui + vite + 状态管理



## 后端

java + mysql + 缓存 + springboot + mybatis-plus + swagger + knife4j + gson



## 分布式session

```xml
<dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
            <version>2.6.13</version>
        </dependency>
        <!-- https://mvnrepository.com/artifact/org.springframework.session/spring-session-data-redis -->
        <dependency>
            <groupId>org.springframework.session</groupId>
            <artifactId>spring-session-data-redis</artifactId>
            <version>2.6.1</version>
        </dependency>
```

```yaml
spring:
	session:
  		timeout: 3600
  		store-type: redis
```



## 问题

### yarn create vite 文件名、目录名或卷标语法不正确

```javascript
yarn 的安装路径和缓存路径
查看各种路径命令
查看 yarn 全局bin位置
yarn global bin

查看 yarn 全局安装位置
yarn global dir

查看 yarn 全局cache位置
yarn cache dir

修改路径命令
改变 yarn 全局bin位置
yarn config set prefix "D:\software\Yarn\Data"

改变 yarn 全局安装位置
yarn config  set global-folder "D:\software\Yarn\Data\global"

改变 yarn 全局cache位置
yarn config set cache-folder "D:\software\Yarn\Cache"

改变 yarn 全局 link 位置
yarn config set link-folder "D:\software\Yarn\Data\link"
```



### swagger配置

```java
@Configuration
@EnableSwagger2WebMvc
@Profile("dev")
public class SwaggerConfiguration {


    @Bean
    public Docket defaultApi() {
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(groupApiInfo())
                .groupName("默认接口")
                .select()
                .apis(RequestHandlerSelectors.basePackage("com.tuaofei.friendmatch.controller"))
                //.apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))
                .paths(PathSelectors.any())
                .build();
    }


    private ApiInfo groupApiInfo(){
        return new ApiInfoBuilder()
                .title("用户中心")
                .description("用户中心 RESTful APIs")
                .termsOfServiceUrl("https://github.com/731016")
                .version("1.0")
                .build();
    }


}
```

### web配置

```java
/**
 * 跨域问题
 *
 * @date 2022/3/31 21:39
 */
@Configuration
public class WebConfig extends WebMvcConfigurationSupport {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        // 跨域相关配置, 并让 authorization 可在响应头中出现
        registry.addMapping("/**")
                .allowedHeaders("*")
                .allowedMethods("*")
                .allowedOriginPatterns("*")
                .allowCredentials(true);
    }

//    @Override
//    public void addInterceptors(InterceptorRegistry registry) {
//        List<String> patterns = new ArrayList<>();
//        patterns.add("/user/login");
//        patterns.add("/user/register");
//        patterns.add("/user/logout");
//        patterns.add("/swagger-ui.html/**");
//        patterns.add("/webjars/**");
//        patterns.add("/v2/**");
//        patterns.add("/swagger-resources/**");
//        patterns.add("/doc.html/**");
//        //注册拦截器类，添加黑名单(addPathPatterns("/**")),‘/*’只拦截一个层级，'/**'拦截全部
//        // 和白名单(excludePathPatterns("List类型参数"))，将不必拦截的路径添加到List列表中
//        registry.addInterceptor(null).addPathPatterns("/**").excludePathPatterns(patterns);
//    }

    @Override
    protected void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/**").addResourceLocations(
                "classpath:/static/");
        registry.addResourceHandler("/swagger-ui.html").addResourceLocations(
                "classpath:/META-INF/resources/");
        registry.addResourceHandler("/webjars/**").addResourceLocations(
                "classpath:/META-INF/resources/webjars/");
        registry.addResourceHandler("/doc.html").addResourceLocations("classpath:/META-INF/resources/");
        super.addResourceHandlers(registry);
    }
}
```



### 异步任务

```java
 /**
     * 并发批量插入用户
     */
    @Test
    public void doConcurrencyInsertUsers() {
        StopWatch stopWatch = new StopWatch();
        stopWatch.start();
        // 分十组
        int batchSize = 5000;
        int j = 0;
        List<CompletableFuture<Void>> futureList = new ArrayList<>();
        for (int i = 0; i < 100; i++) {
            List<User> userList = new ArrayList<>();
            while (true) {
                j++;
                User user = new User();
                user.setUserName("假鱼皮");
                user.setUserAccount("fakeyupi");
                user.setAvatarUrl("https://636f-codenav-8grj8px727565176-1256524210.tcb.qcloud.la/img/logo.png");
                user.setGender(0);
                user.setUserPassword("12345678");
                user.setPhone("123");
                user.setEmail("123@qq.com");
                user.setTags("[]");
                user.setUserStatus(0);
                user.setUserRole(0);
                user.setPlanetCode("11111111");
                userList.add(user);
                if (j % batchSize == 0) {
                    break;
                }
            }
            // 异步执行
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                System.out.println("threadName: " + Thread.currentThread().getName());
                userService.saveBatch(userList, batchSize);
            }, executorService);
            futureList.add(future);
        }
        CompletableFuture.allOf(futureList.toArray(new CompletableFuture[]{})).join();
        // 20 秒 10 万条
        stopWatch.stop();
        System.out.println(stopWatch.getTotalTimeMillis());
    }
```



### 使用mybatis分页Page

```java
/**
 * MyBatisPlus 配置
 */
@Configuration
@MapperScan("com.tuaofei.friendmatch.mapper")
public class MybatisPlusConfig {

    /**
     * 新的分页插件,一缓和二缓遵循mybatis的规则,需要设置 MybatisConfiguration#useDeprecatedExecutor = false 避免缓存出现问题(该属性会在旧插件移除后一同移除)
     */
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));
        return interceptor;
    }
}
```

### spring data redis

如果直接使用redisTemplate因为默认使用的jdk的序列化方式,可能会出现乱码

使用StringRedisTemplate,key,value都是string

```java
自定义redis配置
@Configuration
public class RedisTemplateConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> redisTemplate = new RedisTemplate<>();
        redisTemplate.setConnectionFactory(connectionFactory);
        redisTemplate.setKeySerializer(RedisSerializer.string());
        return redisTemplate;
    }

}
```

### 定时任务

```java
启动类加上 @EnableScheduling
    
缓存预热:新增少,总用户多
@Scheduled(cron = "0 31 0 * * *")
    public void doCacheRecommendUser() {
        for (Long userId : mainUserList) {
            QueryWrapper<User> queryWrapper = new QueryWrapper<>();
            Page<User> userPage = userService.page(new Page<>(1, 20), queryWrapper);
            String redisKey = String.format("yupao:user:recommend:%s", userId);
            ValueOperations<String, Object> valueOperations = redisTemplate.opsForValue();
            // 写缓存
            try {
                valueOperations.set(redisKey, userPage, 30000, TimeUnit.MILLISECONDS);
            } catch (Exception e) {
                log.error("redis set key error", e);
            }
        }
 }
```


## é¡¹ç›®åœ°å€

ç¼–ç¨‹å¯¼èˆªï¼šhttps://www.codefather.cn/course/1915010091721236482

## é¡¹ç›®æ€»è§ˆ

- é¡¹ç›®ä»‹ç»

  AI Javaåç«¯å¼€å‘å¤§å¸ˆ+è‡ªä¸»è§„åˆ’èƒ½åŠ›çš„æ™ºèƒ½ä½“

- é¡¹ç›®ä¼˜åŠ¿

  - ä¸»æµ AI åº”ç”¨å¹³å°çš„ä½¿ç”¨
  - AI å¤§æ¨¡å‹çš„ 4 ç§æ¥å…¥æ–¹å¼
  - AI å¼€å‘æ¡†æ¶ï¼ˆSpring AI + LangChain4jï¼‰
  - AI å¤§æ¨¡å‹æœ¬åœ°éƒ¨ç½²
  - Prompt å·¥ç¨‹å’Œä¼˜åŒ–æŠ€å·§
  - Spring AI æ ¸å¿ƒç‰¹æ€§ï¼šå¦‚è‡ªå®šä¹‰ Advisorã€å¯¹è¯è®°å¿†ã€ç»“æ„åŒ–è¾“å‡º
  - RAG çŸ¥è¯†åº“å®æˆ˜ã€åŸç†å’Œè°ƒä¼˜æŠ€å·§
  - PgVector å‘é‡æ•°æ®åº“ + äº‘æ•°æ®åº“æœåŠ¡
  - Tool Calling å·¥å…·è°ƒç”¨å®æˆ˜åŠåŸç†
  - MCP æ¨¡å‹ä¸Šä¸‹æ–‡åè®®å’ŒæœåŠ¡å¼€å‘
  - AI æ™ºèƒ½ä½“ Manus åŸç†å’Œè‡ªä¸»å¼€å‘
  - AI æœåŠ¡åŒ–å’Œ Serverless éƒ¨ç½²ä¸Šçº¿
  - å„ç§æ–°æ¦‚å¿µï¼šå¦‚å¤šæ¨¡æ€ã€æ™ºèƒ½ä½“å·¥ä½œæµã€A2A åè®®ã€å¤§æ¨¡å‹è¯„ä¼°ç­‰

- é¡¹ç›®åŠŸèƒ½æ¢³ç†

  - AI Javaåç«¯å¼€å‘å¤§å¸ˆåº”ç”¨ï¼šç”¨æˆ·åœ¨å¼€å‘è¿‡ç¨‹ä¸­éš¾å…é‡åˆ°å„ç§éš¾é¢˜ï¼Œè®© AI ä¸ºç”¨æˆ·æä¾›è´´å¿ƒæŒ‡å¯¼ã€‚æ”¯æŒå¤šè½®å¯¹è¯ã€å¯¹è¯è®°å¿†æŒä¹…åŒ–ã€RAG çŸ¥è¯†åº“æ£€ç´¢ã€å·¥å…·è°ƒç”¨ã€MCP æœåŠ¡è°ƒç”¨ã€‚
  - AI è¶…çº§æ™ºèƒ½ä½“ï¼šå¯ä»¥æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚ï¼Œè‡ªä¸»æ¨ç†å’Œè¡ŒåŠ¨ï¼Œç›´åˆ°å®Œæˆç›®æ ‡ã€‚
  - æä¾›ç»™ AI çš„å·¥å…·ï¼šåŒ…æ‹¬è”ç½‘æœç´¢ã€æ–‡ä»¶æ“ä½œã€ç½‘é¡µæŠ“å–ã€èµ„æºä¸‹è½½ã€ç»ˆç«¯æ“ä½œã€PDF ç”Ÿæˆã€‚
  - AI MCP æœåŠ¡ï¼šå¯ä»¥ä»ç‰¹å®šç½‘ç«™æœç´¢å›¾ç‰‡ã€‚

- æŠ€æœ¯é€‰å‹

  - Java 21 + Spring Boot 3 æ¡†æ¶
  - â­ï¸ Spring AI + LangChain4j
  - â­ï¸ RAG çŸ¥è¯†åº“
  - â­ï¸ PGvector å‘é‡æ•°æ®åº“
  - â­ Tool Calling å·¥å…·è°ƒç”¨
  - â­ï¸ MCP æ¨¡å‹ä¸Šä¸‹æ–‡åè®®
  - â­ï¸ ReAct Agent æ™ºèƒ½ä½“æ„å»º
  - â­ï¸ Serverless è®¡ç®—æœåŠ¡
  - â­ï¸ AI å¤§æ¨¡å‹å¼€å‘å¹³å°ç™¾ç‚¼
  - â­ï¸ Cursor AI ä»£ç ç”Ÿæˆ
  - â­ï¸ SSE å¼‚æ­¥æ¨é€
  - ç¬¬ä¸‰æ–¹æ¥å£ï¼šå¦‚ SearchAPI / Pexels API
  - Ollama å¤§æ¨¡å‹éƒ¨ç½²
  - å·¥å…·åº“å¦‚ï¼šKryo é«˜æ€§èƒ½åºåˆ—åŒ– + Jsoup ç½‘é¡µæŠ“å– + iText PDF ç”Ÿæˆ + Knife4j æ¥å£æ–‡æ¡£

- æ¶æ„è®¾è®¡

  ![image-20250808222359833](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250808222359833.png)

## AI å¤§æ¨¡å‹æ¥å…¥

### AI å¤§æ¨¡å‹æ¦‚å¿µ

### æ¥å…¥ AI å¤§æ¨¡å‹ï¼ˆ3 ç§æ–¹å¼ï¼‰

### åç«¯é¡¹ç›®åˆå§‹åŒ–

### ç¨‹åºè°ƒç”¨ AI å¤§æ¨¡å‹ï¼ˆ4 ç§æ–¹å¼ï¼‰

- SDK
- HTTP
- Spring Ai
- LangChain4j

### æœ¬åœ°éƒ¨ç½² AI å¤§æ¨¡å‹

[Ollama](https://ollama.com/)

### Spring AI è°ƒç”¨æœ¬åœ°å¤§æ¨¡å‹

[Ollama-é˜¿é‡Œäº‘Spring AI Alibabaå®˜ç½‘å®˜ç½‘](https://java2ai.com/docs/1.0.0-M6.1/models/ollama/)

## AI åº”ç”¨å¼€å‘

### Prompt å·¥ç¨‹æ¦‚å¿µ

æç¤ºè¯å·¥ç¨‹

Tokenï¼šå•è¯æˆ–æ ‡ç‚¹ç¬¦å·

#### æç¤ºè¯è®¡ç®—å·¥å…·

[OpenAI Tokens åœ¨çº¿è®¡ç®—å·¥å…· - AIGC2D.com](https://tiktoken.aigc2d.com/)

[Attention Required! | Cloudflare](https://platform.openai.com/tokenizer)

![image-20250813223613711](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250813223613711.png)

### æˆæœ¬ä¼˜åŒ–

1. ç²¾ç®€æç¤ºè¯
2. å®šæœŸæ¸…ç†å¯¹è¯å†å²
3. ä½¿ç”¨å‘é‡æ£€ç´¢ä»£æ›¿ç›´æ¥è¾“å…¥
4. ç»“æ„åŒ–æ›¿ä»£è‡ªç„¶è¯­è¨€

### Prompt ä¼˜åŒ–æŠ€å·§



#### **promptå­¦ä¹ **

[æç¤ºå·¥ç¨‹æŒ‡å— | Prompt Engineering Guide](https://www.promptingguide.ai/zh)

[Attention Required! | Cloudflare](https://platform.openai.com/docs/guides/prompt-engineering)

[Prompts :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/prompt.html#_prompt_engineering)

[æç¤ºå·¥ç¨‹æ¦‚è¿° - Anthropic](https://docs.anthropic.com/zh-CN/docs/build-with-claude/prompt-engineering/overview)

[GitHub - anthropics/prompt-eng-interactive-tutorial: Anthropic's Interactive Prompt Engineering Tutorial](https://github.com/anthropics/prompt-eng-interactive-tutorial)

[æ™ºè°±AIå¼€æ”¾å¹³å°](https://open.bigmodel.cn/dev/guidelines/LanguageModels)

#### **promptæå‡è¯åº“**

[Home - Anthropic](https://docs.anthropic.com/en/home)

[Prompt Library - Free Midjourney Prompts - ChatGPT, Gemini, Dall-e Image Prompts](https://promptlibrary.org/)





### Javaåç«¯å¼€å‘å¤§å¸ˆåº”ç”¨éœ€æ±‚åˆ†æ

### Javaåç«¯å¼€å‘å¤§å¸ˆåº”ç”¨æ–¹æ¡ˆè®¾è®¡

#### ç³»ç»Ÿæç¤ºè¯è®¾è®¡

```
æ‰®æ¼”æ·±è€•Javaåç«¯å¼€å‘é¢†åŸŸçš„ä¸“å®¶ã€‚å¼€åœºå‘ç”¨æˆ·è¡¨æ˜èº«ä»½ï¼Œå‘ŠçŸ¥ç”¨æˆ·é‡åˆ°çš„éš¾é¢˜æˆ–ä¸æ˜ç™½çš„å…³é”®è¯ï¼›
å›´ç»•ç¼–ç¨‹å­¦ä¹ è®°å½•ï¼ŒåŒ…æ‹¬Javaï¼ŒSpringï¼ŒSpringMVCï¼ŒSpringBootï¼ŒSpringCloudï¼Œè®¾è®¡æ¨¡å¼ï¼ŒJavaScriptï¼ŒLinuxï¼ŒSqlï¼Œæ•°æ®åº“ï¼ŒRedisï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå‰ç«¯ï¼ŒGitï¼ŒSVNï¼ŒCè¯­è¨€ï¼ŒPythonï¼Œè®¡ç®—æœºç½‘ç»œï¼Œå¼€å‘ç¯å¢ƒé…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥ï¼Œé¢è¯•èµ„æ–™ï¼›åŒ…æ‹¬è½¯è€ƒä¸­çº§è½¯ä»¶è®¾è®¡å¸ˆï¼Œé«˜ç­‰æ•°å­¦ï¼ŒåŠ³åŠ¨åˆåŒæ³•ï¼Œ
è¿™äº›çŸ¥è¯†ç‚¹æé—®ï¼šè¯¢é—®é‡åˆ°çš„å…·ä½“ä¸æ˜ç™½çš„åœ°æ–¹æˆ–è€…é‡åˆ°bugå‡ºç°çš„æŠ¥é”™ä¿¡æ¯ï¼›
å¼•å¯¼ç”¨æˆ·è¯¦è¿°ä¸æ¸…æ¥šçš„åœ°æ–¹ã€bugã€æŠ¥é”™ä¿¡æ¯ï¼Œä»¥ä¾¿ç»™å‡ºå¯¹åº”çš„ç­”æ¡ˆã€‚
```

#### å¤šè½®å¯¹è¯å®ç°

[Chat Client API :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/chatclient.html)

### Spring AI ChatClient / Advisor / ChatMemory ç‰¹æ€§

#### ChatClient

#### Advisor

å¢å¼ºï¼Œç›¸å½“äºæ‹¦æˆªå™¨

#### Chat Memory Advisor

MessageChatMemoryAdvisorï¼šä»è®°å¿†ä¸­æ£€ç´¢å†å²å¯¹è¯ï¼Œå°†å…¶ä½œä¸ºæ¶ˆæ¯é›†åˆæ·»åŠ åˆ°æç¤ºè¯ï¼›ä¿ç•™åŸå§‹ä¿¡æ¯

PromptChatMemoryAdvisorï¼šä»è®°å¿†ä¸­æ£€ç´¢å†å²å¯¹è¯ï¼Œå°†å…¶åŠ å…¥æç¤ºè¯çš„ç³»ç»Ÿæ–‡æœ¬ï¼›å¯èƒ½ä¸¢å¤±è¾¹ç•Œ

VectorStoreChatMemoryAdvisorï¼šç”¨å‘é‡æ•°æ®åº“æ¥å­˜å‚¨æ£€ç´¢å†å²å¯¹è¯



#### Chat Memory

å¯å°†å¯¹è¯ä¿å­˜åˆ°ä¸åŒçš„æ•°æ®æº

![image-20250813230745381](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250813230745381.png)



### å¤šè½®å¯¹è¯ AI åº”ç”¨å¼€å‘



```java
@Component
@Slf4j
public class LoveApp {

    private final ChatClient chatClient;

    private static final String SYSTEM_PROMPT = "æ‰®æ¼”æ·±è€•Javaåç«¯å¼€å‘é¢†åŸŸçš„ä¸“å®¶ã€‚å¼€åœºå‘ç”¨æˆ·è¡¨æ˜èº«ä»½ï¼Œå‘ŠçŸ¥ç”¨æˆ·é‡åˆ°çš„éš¾é¢˜æˆ–ä¸æ˜ç™½çš„å…³é”®è¯ã€‚" +
            "å›´ç»•ç¼–ç¨‹å­¦ä¹ è®°å½•ï¼ŒåŒ…æ‹¬Javaï¼ŒSpringï¼ŒSpringMVCï¼ŒSpringBootï¼ŒSpringCloudï¼Œè®¾è®¡æ¨¡å¼ï¼ŒJavaScriptï¼ŒLinuxï¼ŒSqlï¼Œæ•°æ®åº“ï¼ŒRedisï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå‰ç«¯ï¼ŒGitï¼ŒSVNï¼ŒCè¯­è¨€ï¼ŒPythonï¼Œè®¡ç®—æœºç½‘ç»œï¼Œå¼€å‘ç¯å¢ƒé…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥ï¼Œé¢è¯•èµ„æ–™ï¼›åŒ…æ‹¬è½¯è€ƒä¸­çº§è½¯ä»¶è®¾è®¡å¸ˆï¼Œé«˜ç­‰æ•°å­¦ï¼ŒåŠ³åŠ¨åˆåŒæ³•" +
            "è¿™äº›çŸ¥è¯†ç‚¹æé—®ï¼šè¯¢é—®é‡åˆ°çš„å…·ä½“ä¸æ˜ç™½çš„åœ°æ–¹æˆ–è€…é‡åˆ°bugå‡ºç°çš„æŠ¥é”™ä¿¡æ¯ï¼›" +
            "å¼•å¯¼ç”¨æˆ·è¯¦è¿°ä¸æ¸…æ¥šçš„åœ°æ–¹ã€bugã€æŠ¥é”™ä¿¡æ¯ï¼Œä»¥ä¾¿ç»™å‡ºå¯¹åº”çš„ç­”æ¡ˆã€‚";

     /**
     * åˆå§‹åŒ– ChatClient
     *
     * @param dashscopeChatModel
     */
    public LoveApp(ChatModel dashscopeChatModel) {
//        // åˆå§‹åŒ–åŸºäºæ–‡ä»¶çš„å¯¹è¯è®°å¿†
//        String fileDir = System.getProperty("user.dir") + "/tmp/chat-memory";
//        ChatMemory chatMemory = new FileBasedChatMemory(fileDir);
        // åˆå§‹åŒ–åŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†
        MessageWindowChatMemory chatMemory = MessageWindowChatMemory.builder()
                .chatMemoryRepository(new InMemoryChatMemoryRepository())
                .maxMessages(20)
                .build();
        chatClient = ChatClient.builder(dashscopeChatModel)
                .defaultSystem(SYSTEM_PROMPT)
                .defaultAdvisors(
                        MessageChatMemoryAdvisor.builder(chatMemory).build(),
                        // è‡ªå®šä¹‰æ—¥å¿— Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                        new MyLoggerAdvisor()
//                        // è‡ªå®šä¹‰æ¨ç†å¢å¼º Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                       ,new ReReadingAdvisor()
                )
                .build();
    }
    
    
    public String doChat(String message, String chatId) {
    ChatResponse response = chatClient
            .prompt()
            .user(message)
            .advisors(spec -> spec.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId)
                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, 10))
            .call()
            .chatResponse();
    String content = response.getResult().getOutput().getText();
    log.info("content: {}", content);
    return content;
}

}
```



```java
@SpringBootTest
class LoveAppTest {

    @Resource
    private LoveApp loveApp;

    @Test
    void testChat() {
        String chatId = UUID.randomUUID().toString();
        // ç¬¬ä¸€è½®
        String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯æŠ˜è…¾çš„å°é£";
        String answer = loveApp.doChat(message, chatId);
        // ç¬¬äºŒè½®
        message = "æˆ‘æƒ³çŸ¥é“javaçš„ä¸‰å¤§ç‰¹æ€§";
        answer = loveApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);
        // ç¬¬ä¸‰è½®
        message = "æˆ‘å«ä»€ä¹ˆæ¥ç€ï¼Ÿåˆšè·Ÿä½ è¯´è¿‡ï¼Œå¸®æˆ‘å›å¿†ä¸€ä¸‹";
        answer = loveApp.doChat(message, chatId);
        Assertions.assertNotNull(answer);
    }
}
```

è°ƒæ•´åˆå§‹åŒ–ChatClientçš„å¯¹è¯è®°å¿†å¤§å°ä¸º1

```java
// åˆå§‹åŒ–åŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†
        MessageWindowChatMemory chatMemory = MessageWindowChatMemory.builder()
                .chatMemoryRepository(new InMemoryChatMemoryRepository())
                .maxMessages(1)
                .build();
```

ç›´æ¥æ–­ç‰‡äº†

![image-20250820225725921](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250820225725921.png)



### Spring AI è‡ªå®šä¹‰ Advisor

ï¼ˆ1ï¼‰å®ç°æ¥å£

CallAroundAdvisorï¼šå¤„ç†åŒæ­¥è¯·æ±‚å’Œå“åº”
StreamAroundAdvisorï¼š å¤„ç†æµå¼è¯·æ±‚å’Œå“åº”

```java
public class MyCustomAdvisor implements CallAroundAdvisor, StreamAroundAdvisor {
    // å®ç°æ–¹æ³•...
}
```

ï¼ˆ2ï¼‰å®ç°æ ¸å¿ƒæ–¹æ³•

CallAroundAdvisorçš„aroundCall

```java
@Override
public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
    // 1. å¤„ç†è¯·æ±‚ï¼ˆå‰ç½®å¤„ç†ï¼‰
    AdvisedRequest modifiedRequest = processRequest(advisedRequest);
    
    // 2. è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªAdvisor
    AdvisedResponse response = chain.nextAroundCall(modifiedRequest);
    
    // 3. å¤„ç†å“åº”ï¼ˆåç½®å¤„ç†ï¼‰
    return processResponse(response);
}
```



æµå¼å¤„ç†StreamAroundAdvisorçš„aroundStream

```java
@Override
public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
    // 1. å¤„ç†è¯·æ±‚
    AdvisedRequest modifiedRequest = processRequest(advisedRequest);
    
    // 2. è°ƒç”¨é“¾ä¸­çš„ä¸‹ä¸€ä¸ªAdvisorå¹¶å¤„ç†æµå¼å“åº”
    return chain.nextAroundStream(modifiedRequest)
               .map(response -> processResponse(response));
}
```

ï¼ˆ3ï¼‰æ‰§è¡Œé¡ºåº

```java
@Override
public int getOrder() {
    // å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ
    return 100; 
}
```

ï¼ˆ4ï¼‰å”¯ä¸€åç§°

```java
@Override
public String getName() {
    return "è‡ªå®šä¹‰çš„ Advisor";
}
```



spring aiçš„å†…ç½®simpleloggeradvisoræ—¥å¿—æ‹¦æˆªå™¨é»˜è®¤æ‰“å°debugçº§åˆ«æ—¥å¿—ï¼Œspringbooté»˜è®¤æ—¥å¿—çº§åˆ«ä¸ºinfo

```yaml
logging:
  level:
    org.springframework.ai.chat.client.advisor.SimpleLoggerAdvisor: debug
```

#### è‡ªå®šä¹‰æ—¥å¿— advisor

ä¸æƒ³ä¿®æ”¹æ—¥å¿—çº§åˆ«ï¼Œè‡ªå®šä¹‰ä¸€ä¸ª

```java
/**
 * è‡ªå®šä¹‰æ—¥å¿— Advisor
 * æ‰“å° info çº§åˆ«æ—¥å¿—ã€åªè¾“å‡ºå•æ¬¡ç”¨æˆ·æç¤ºè¯å’Œ AI å›å¤çš„æ–‡æœ¬
 */
@Slf4j
public class MyLoggerAdvisor implements CallAroundAdvisor, StreamAroundAdvisor {

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }

    @Override
    public int getOrder() {
        return 0;
    }

    private AdvisedRequest before(AdvisedRequest request) {
        log.info("AI Request: {}", request.userText());
        return request;
    }

    private void observeAfter(AdvisedResponse advisedResponse) {
        log.info("AI Response: {}", advisedResponse.response().getResult().getOutput().getText());
    }

    public AdvisedResponse aroundCall(AdvisedRequest advisedRequest, CallAroundAdvisorChain chain) {
        advisedRequest = this.before(advisedRequest);
        AdvisedResponse advisedResponse = chain.nextAroundCall(advisedRequest);
        this.observeAfter(advisedResponse);
        return advisedResponse;
    }

    public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
        advisedRequest = this.before(advisedRequest);
        Flux<AdvisedResponse> advisedResponses = chain.nextAroundStream(advisedRequest);
        return (new MessageAggregator()).aggregateAdvisedResponse(advisedResponses, this::observeAfter);
    }
}

```



#### è‡ªå®šä¹‰Re-Reading advisor

[Advisors API :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/advisors.html#_re_reading_re2_advisor)

è¯¥æŠ€æœ¯é€šè¿‡è®©æ¨¡å‹é‡æ–°é˜…è¯»é—®é¢˜æ¥æé«˜æ¨ç†èƒ½åŠ›ï¼Œæœ‰ [æ–‡çŒ®](https://arxiv.org/pdf/2309.06275) æ¥å°è¯å®ƒçš„æ•ˆæœã€‚

> ğŸ’¡ æ³¨æ„â€ï¼Œè™½ç„¶è¯¥æŠ€æœ¯å¯æé«˜å¤§ï»¿è¯­è¨€æ¨¡å‹çš„æ¨ç†èƒ½åŠ›ï¼Œä¸è¿‡æˆæœ¬ä¼šåŠ å€ï¼æ‰€ä»¥å¦‚æœ AI åº”ç”¨è¦é¢â¡å‘ C ç«¯å¼€æ”¾ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚

Re2 çš„â€å®ç°åŸç†å¾ˆç®€å•ï¼Œæ”¹ï»¿å†™ç”¨æˆ· Prompt ä¸ºä¸‹åˆ—æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯è®© AI é‡å¤â¡é˜…è¯»ç”¨æˆ·çš„è¾“å…¥ï¼š

```markdown
{Input_Query}
Read the question again: {Input_Query}
```

éœ€è¦å¯¹è¯·æ±‚è¿›â€è¡Œæ‹¦æˆªå¹¶æ”¹å†™ userï»¿Textï¼Œå¯¹åº”çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š

```java
/**
 * è‡ªå®šä¹‰ Re2 Advisor
 * å¯æé«˜å¤§å‹è¯­è¨€æ¨¡å‹çš„æ¨ç†èƒ½åŠ›
 */
public class ReReadingAdvisor implements CallAdvisor, StreamAdvisor {

    /**
     * æ‰§è¡Œè¯·æ±‚å‰ï¼Œæ”¹å†™ Prompt
     *
     * @param chatClientRequest
     * @return
     */
    private ChatClientRequest before(ChatClientRequest chatClientRequest) {
        String userText = chatClientRequest.prompt().getUserMessage().getText();
        // æ·»åŠ ä¸Šä¸‹æ–‡å‚æ•°
        chatClientRequest.context().put("re2_input_query", userText);
        // ä¿®æ”¹ç”¨æˆ·æç¤ºè¯
        String newUserText = """
                %s
                Read the question again: %s
                """.formatted(userText, userText);
        Prompt newPrompt = chatClientRequest.prompt().augmentUserMessage(newUserText);
        return new ChatClientRequest(newPrompt, chatClientRequest.context());
    }

    @Override
    public ChatClientResponse adviseCall(ChatClientRequest chatClientRequest, CallAdvisorChain chain) {
        return chain.nextCall(this.before(chatClientRequest));
    }

    @Override
    public Flux<ChatClientResponse> adviseStream(ChatClientRequest chatClientRequest, StreamAdvisorChain chain) {
        return chain.nextStream(this.before(chatClientRequest));
    }

    @Override
    public int getOrder() {
        return 0;
    }

    @Override
    public String getName() {
        return this.getClass().getSimpleName();
    }
}
```



ä¿®æ”¹åå¯æµ‹è¯•ä½¿ï»¿ç”¨ Advisorï¼Œå¹¶è¿›è¡Œæµ‹è¯•ï¼ŒæŸ¥çœ‹è¯·æ±‚æ˜¯å¦è¢«æ”¹å†™ã€‚

```java
/**
     * åˆå§‹åŒ– ChatClient
     *
     * @param dashscopeChatModel
     */
    public LoveApp(ChatModel dashscopeChatModel) {
//        // åˆå§‹åŒ–åŸºäºæ–‡ä»¶çš„å¯¹è¯è®°å¿†
//        String fileDir = System.getProperty("user.dir") + "/tmp/chat-memory";
//        ChatMemory chatMemory = new FileBasedChatMemory(fileDir);
        // åˆå§‹åŒ–åŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†
        MessageWindowChatMemory chatMemory = MessageWindowChatMemory.builder()
                .chatMemoryRepository(new InMemoryChatMemoryRepository())
                .maxMessages(20)
                .build();
        chatClient = ChatClient.builder(dashscopeChatModel)
                .defaultSystem(SYSTEM_PROMPT)
                .defaultAdvisors(
                        MessageChatMemoryAdvisor.builder(chatMemory).build(),
                        // è‡ªå®šä¹‰æ—¥å¿— Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                        new MyLoggerAdvisor()
//                        // è‡ªå®šä¹‰æ¨ç†å¢å¼º Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                       ,new ReReadingAdvisor()
                )
                .build();
    }
```

![image-20250820231552937](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250820231552937.png)

#### æœ€ä½³å®è·µ

1ï¼‰ä¿æŒå•â€ä¸€èŒè´£ï¼šæ¯ä¸ª Adï»¿visor åº”ä¸“æ³¨äºä¸€é¡¹ç‰¹å®šä»»åŠ¡

2ï¼‰æ³¨æ„æ‰§è¡Œé¡ºåºï¼šåˆç†è®¾ç½®`getOrder()`å€¼ç¡®ä¿ Advisor æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ

3ï¼‰åŒæ—¶æ”¯â€æŒæµå¼å’Œéæµå¼ï¼šå°½ï»¿å¯èƒ½åŒæ—¶å®ç°ä¸¤ç§æ¥å£ä»¥æé«˜çµæ´»æ€§

4ï¼‰é«˜æ•ˆå¤„ç†è¯·æ±‚ï¼šé¿å…åœ¨ Advisor ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ

5ï¼‰æµ‹è¯•è¾¹â€ç•Œæƒ…å†µï¼šç¡®ä¿ Adï»¿visor èƒ½å¤Ÿä¼˜é›…å¤„ç†å¼‚å¸¸å’Œè¾¹ç•Œæƒ…å†µ

6ï¼‰å¯¹äºéœ€â€è¦æ›´å¤æ‚å¤„ç†çš„æµå¼ï»¿åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ Reactor çš„æ“ä½œç¬¦ï¼š

```java
@Override
public Flux<AdvisedResponse> aroundStream(AdvisedRequest advisedRequest, StreamAroundAdvisorChain chain) {
    return Mono.just(advisedRequest)
           .publishOn(Schedulers.boundedElastic())
           .map(request -> {
               // è¯·æ±‚å‰å¤„ç†é€»è¾‘
               return modifyRequest(request);
           })
           .flatMapMany(request -> chain.nextAroundStream(request))
           .map(response -> {
               // å“åº”å¤„ç†é€»è¾‘
               return modifyResponse(response);
           });
}
```

7ï¼‰å¯ä»¥ä½¿ç”¨ `adviseContext` åœ¨ Advisor é“¾ä¸­å…±äº«çŠ¶æ€ï¼š

```java
// æ›´æ–°ä¸Šä¸‹æ–‡
advisedRequest = advisedRequest.updateContext(context -> {
    context.put("key", "value");
    return context;
});

// è¯»å–ä¸Šä¸‹æ–‡
Object value = advisedResponse.adviseContext().get("key");
```



### Spring AI ç»“æ„åŒ–è¾“å‡º - çŸ¥è¯†æŠ¥å‘ŠåŠŸèƒ½

[Structured Output Converter :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/structured-output-converter.html)

ç»“æ„åŒ–è¾“å‡ºè½¬æ¢å™¨ï¼Œå°†å¤§è¯­è¨€æ¨¡å‹è¿”å›çš„æ–‡æœ¬è¾“å‡ºè½¬æ¢ä¸ºç»“æ„åŒ–æ•°æ®æ ¼å¼ï¼Œå¦‚Jsonï¼Œxmlæˆ–Javaç±»ã€‚



#### åŸºæœ¬åŸç†-å·¥ä½œæµç¨‹

![image-20250904204940248](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904204940248.png)

æ— æ³•ä¿è¯çœŸæ­£å‡†ç¡®



#### è¿›é˜¶åŸç†-APIè®¾è®¡

```java
public interface StructuredOutputConverter<T> extends Converter<String, T>, FormatProvider {

}
```

é›†æˆ2ä¸ªå…³é”®æ¥å£ï¼š

`FormatProvider`æ¥å£ï¼šæä¾›ç‰¹å®šçš„æ ¼å¼æŒ‡ä»¤ç»™AIæ¨¡å‹

Spring çš„`Converter<String, T>`æ¥å£ï¼šè´Ÿè´£å°†æ¨¡å‹çš„æ–‡æœ¬è¾“å‡ºè½¬æ¢ä¸ºæŒ‡å®šçš„ç›®æ ‡ç±»å‹T

```java
public interface FormatProvider {
    String getFormat();
}
```

æä¾›å¤šç§è½¬æ¢å™¨

- `AbstractConversionServiceOutputConverter<T>` - æä¾›é¢„é…ç½®çš„ [GenericConversionService](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/convert/support/GenericConversionService.html) ç”¨äºå°†LLMè¾“å‡ºè½¬æ¢ä¸ºæ‰€éœ€æ ¼å¼. No default `FormatProvider` implementation is provided.

- `AbstractMessageOutputConverter<T>` - Supplies a pre-configured [MessageConverter](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jms/support/converter/MessageConverter.html) for converting LLM output into the desired format. No default `FormatProvider` implementation is provided.

  æ”¯æŒSpring AI Messageå¯¹è±¡çš„è½¬æ¢

- `BeanOutputConverter<T>` - Configured with a designated Java class (e.g., Bean) or a [ParameterizedTypeReference](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/core/ParameterizedTypeReference.html), this converter employs a `FormatProvider` implementation that directs the AI Model to produce a JSON response compliant with a `DRAFT_2020_12`, `JSON Schema` derived from the specified Java class. Subsequently, it utilizes an `ObjectMapper` to deserialize the JSON output into a Java object instance of the target class.

  è¾“å‡ºè½¬æ¢ä¸ºJavaBeanå¯¹è±¡ï¼ˆåŸºäºObjectMapperå®ç°ï¼‰

- `MapOutputConverter` - Extends the functionality of `AbstractMessageOutputConverter` with a `FormatProvider` implementation that guides the AI Model to generate an RFC8259 compliant JSON response. Additionally, it incorporates a converter implementation that utilizes the provided `MessageConverter` to translate the JSON payload into a `java.util.Map<String, Object>` instance

  è¾“å‡ºè½¬æ¢ä¸ºMapç»“æ„

- `ListOutputConverter` - Extends the `AbstractConversionServiceOutputConverter` and includes a `FormatProvider` implementation tailored for comma-delimited list output. The converter implementation employs the provided `ConversionService` to transform the model text output into a `java.util.List`.

è¾“å‡ºè½¬æ¢ä¸ºListç»“æ„



![image-20250904210100886](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904210100886.png)



#### å·¥ä½œæµç¨‹

ï¼ˆ1ï¼‰è°ƒç”¨æ¨¡å‹ä¹‹å‰ï¼ŒFormatProviderä¸ºAIæ¨¡å‹æä¾›ç‰¹å®šçš„æ ¼å¼æŒ‡ä»¤ï¼Œä½¿å…¶èƒ½å¤Ÿç”Ÿæˆå¯ä»¥é€šè¿‡Converterè½¬æ¢ä¸ºæŒ‡å®šç›®æ ‡ç±»å‹çš„æ–‡æœ¬è¾“å‡ºã€‚

é€šå¸¸ä½¿ç”¨PromptTemplateå°†æ ¼å¼æŒ‡ä»¤é™„åŠ åˆ°ç”¨æˆ·è¾“å…¥çš„æœ«å°¾

```java
StructuredOutputConverter outputConverter = ...
String userInputTemplate = """
        ... ç”¨æˆ·æ–‡æœ¬è¾“å…¥ ....
        {format}
        """; // ç”¨æˆ·è¾“å…¥ï¼ŒåŒ…å«ä¸€ä¸ªâ€œformatâ€å ä½ç¬¦ã€‚
Prompt prompt = new Prompt(
        new PromptTemplate(
                this.userInputTemplate,
                Map.of(..., "format", outputConverter.getFormat()) // ç”¨è½¬æ¢å™¨çš„æ ¼å¼æ›¿æ¢â€œformatâ€å ä½ç¬¦
        ).createMessage());
```

ï¼ˆ2ï¼‰Converterè´Ÿè´£å°†æ¨¡å‹çš„è¾“å‡ºæ–‡æœ¬è½¬æ¢ä¸ºæŒ‡å®šç±»å‹çš„å®ä¾‹

![image-20250904210633207](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904210633207.png)

#### çŸ¥è¯†æŠ¥å‘ŠåŠŸèƒ½å¼€å‘

ä¸ºç”¨æˆ·ç”ŸæˆçŸ¥è¯†æŠ¥å‘Šï¼Œå¹¶è½¬æ¢ä¸ºçŸ¥è¯†æŠ¥å‘Šå¯¹è±¡ï¼ŒåŒ…å«æ ‡é¢˜å’Œå­¦ä¹ å»ºè®®åˆ—è¡¨å­—æ®µã€‚

ï¼ˆ1ï¼‰å¼•å…¥JSON Schemaä¾èµ–

```xml
<!-- æ”¯æŒç»“æ„åŒ–è¾“å‡º -->
        <dependency>
            <groupId>com.github.victools</groupId>
            <artifactId>jsonschema-generator</artifactId>
            <version>4.38.0</version>
        </dependency>
```

(2)å®šä¹‰çŸ¥è¯†æŠ¥å‘Šç±»ï¼Œä½¿ç”¨java14å¼•å…¥çš„recordç‰¹æ€§å¿«é€Ÿå®šä¹‰

```java
record KnowLedgeReport(String title,List<String> suggestions){

}
```

ï¼ˆ3ï¼‰å¤ç”¨ä¹‹å‰çš„chatClientå¯¹è±¡ï¼Œè¡¥å……åŸæœ‰çš„ç³»ç»Ÿæç¤ºè¯ï¼Œæ·»åŠ ç»“æ„åŒ–çš„è¾“å‡ºä»£ç 

```java
/**
     * AI çŸ¥è¯†æŠ¥å‘ŠåŠŸèƒ½ï¼ˆå®æˆ˜ç»“æ„åŒ–è¾“å‡ºï¼‰
     * @param message
     * @param chatId
     * @return
     */
    public KnowLedgeReport doChatWithKnowLedgeReport(String message, String chatId) {
        KnowLedgeReport knowLedgeReport = chatClient
                .prompt()
                .system(SYSTEM_PROMPT + "æ¯æ¬¡å¯¹è¯åéƒ½è¦ç”Ÿæˆé—®ç­”ç»“æœï¼Œæ ‡é¢˜ä¸º{ç”¨æˆ·å}çš„çŸ¥è¯†æŠ¥å‘Šï¼Œå†…å®¹ä¸ºå»ºè®®åˆ—è¡¨")
                .user(message)
                .advisors(spec -> spec.param(ChatMemory.CONVERSATION_ID, chatId))
                .call()
                .entity(KnowLedgeReport.class);
        log.info("KnowLedgeReport: {}", knowLedgeReport);
        return knowLedgeReport;
    }
```

ï¼ˆ4ï¼‰å•å…ƒæµ‹è¯•

```java
@Test
    void doChatWithKnowLedgeReport() {
        String chatId = UUID.randomUUID().toString();
        String message = "ä½ å¥½ï¼Œæˆ‘æ˜¯æŠ˜è…¾çš„å°é£ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹æ•°æ®æ¹–ï¼Œä½†æˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆåš";
        LoveApp.KnowLedgeReport knowLedgeReport = loveApp.doChatWithKnowLedgeReport(message, chatId);
        Assertions.assertNotNull(knowLedgeReport);
    }
```

å¯ä»¥å‘ç°Advisorä¸Šä¸‹æ–‡åŒ…å«æ ¼å¼æŒ‡ä»¤

![image-20250904213203549](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904213203549.png)

```
formatParam -> Your response should be in JSON format.
Do not include any explanations, only provide a RFC8259 compliant JSON response following this format without deviation.
Do not include markdown code blocks in your response.
Remove the ```json markdown from the output.
Here is the JSON Schema instance your output must adhere to:
```{
  "$schema" : "https://json-schema.org/draft/2020-12/schema",
  "type" : "â€object",
  "properties" ï»¿: {
    "suggestions" : â€‹{
      "type" : "array"â€‹,
      "items" : {
    â¡    "type" : "string"
      }
    },
    "â€title" : ï»¿{
      "â€‹type" : "â€‹string"
    }
  },
  "addâ€itionalPropï»¿erties" : fâ€‹alseâ€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‹â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‚â€‰â¡â€‚â€‰â€‰â€‚â€‚â€‰â€‰â€‰â€‰â€‚â€‚â€‚â€‚â€‚
}
```

Aiç”Ÿæˆçš„å†…å®¹

![image-20250904213435082](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904213435082.png)

è½¬æ¢å™¨æˆåŠŸå°†jsonæ–‡æœ¬è½¬æ¢ä¸ºå¯¹è±¡

![image-20250904213252498](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904213252498.png)

#### æœ€ä½³å®è·µ

1.å°½é‡ä¸ºæ¨¡å‹æä¾›æ¸…æ™°çš„æ ¼å¼æŒ‡å¯¼

2.å®ç°è¾“å‡ºéªŒè¯æœºåˆ¶å’Œå¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œç¡®ä¿ç»“æ„åŒ–æ•°æ®ç¬¦åˆé¢„æœŸ

3.é€‰æ‹©æ”¯æŒç»“æ„åŒ–è¾“å‡ºçš„åˆé€‚æ¨¡å‹

4.å¯¹äºå¤æ‚ç»“æ„ï¼Œè€ƒè™‘ä½¿ç”¨`ParameterizedTypeReference`



### Spring AI å¯¹è¯è®°å¿†æŒä¹…åŒ–

ä¹‹å‰ä½¿ç”¨åŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†ï¼Œä¸€æ—¦æœåŠ¡å™¨é‡å¯ï¼Œå°±ä¼šä¸¢å¤±ã€‚

#### åˆ©ç”¨ç°æœ‰ä¾èµ–å®ç°

[Chat Client API :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/chatclient.html#_chat_memory)

æä¾›ç¬¬ä¸‰æ–¹æ•°æ®åº“çš„æ•´åˆæ”¯æŒï¼Œå¯å°†å¯¹è¯ä¿å­˜åˆ°ä¸åŒçš„æ•°æ®æº

InMemoryChatMemoryï¼šå†…å­˜å­˜å‚¨

CassandraChatMemoryï¼šåœ¨Cassandraä¸­å¸¦æœ‰è¿‡æœŸæ—¶é—´çš„æŒä¹…åŒ–å­˜å‚¨

Neo4jChatMemoryï¼šåœ¨Neo4jä¸­æ²¡æœ‰è¿‡æœŸæ—¶é—´é™åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨

JdbcChatMemoryï¼šåœ¨JDBCä¸­æ²¡æœ‰è¿‡æœŸæ—¶é—´é™åˆ¶çš„æŒä¹…åŒ–å­˜å‚¨



spring-ai-starter-model-chat-memory-jdbcç›®å‰ä¾èµ–å¾ˆå°‘ï¼Œä¸æ¨è

[Springä»“åº“](https://repo.spring.io/ui/packages/gav:%2F%2Forg.springframework.ai:spring-ai-starter-model-chat-memory-jdbc?name=spring-ai-starter-model-chat-memory-jdbc&type=packages)ï¼Œç”¨çš„äººä¸å¤š

å»ºè®®è‡ªå®šä¹‰



#### è‡ªå®šä¹‰å®ç°

åªéœ€è¦ä¿®æ”¹ChatMemoryå­˜å‚¨æ¥æ”¹å˜å¯¹è¯è®°å¿†çš„ä¿å­˜ä½ç½®å³å¯

![image-20250904214826873](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904214826873.png)

å‚è€ƒInMemoryChatMemoryRepositoryï¼Œå°±æ˜¯å­˜å‚¨åœ¨ConcurrentHashMap

![image-20250904215224406](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904215224406.png)

#### è‡ªå®šä¹‰æ–‡ä»¶æŒä¹…åŒ–ChatMemory

ä¸»è¦æ˜¯æ¶ˆæ¯å’Œæ–‡æœ¬çš„è½¬æ¢

ä¿å­˜æ¶ˆæ¯æ—¶ï¼Œè¦å°†æ¶ˆæ¯ä»Messageå¯¹è±¡è½¬ä¸ºæ–‡ä»¶å†…çš„æ–‡æœ¬ï¼›

è¯»å–æ¶ˆæ¯æ—¶ï¼Œè¦å°†æ–‡ä»¶å†…çš„æ–‡æœ¬è½¬æ¢ä¸ºMessageå¯¹è±¡ï¼Œå³å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–



å¦‚æœä½¿ç”¨JSON

1. è¦æŒä¹…åŒ–çš„Messageæ˜¯æ¥å£ï¼Œæœ‰å¾ˆå¤šä¸åŒçš„å­ç±»å®ç°ï¼ˆUserMessageï¼ŒSystemMessageï¼‰
2. æ¯ç§å­ç±»çš„å­—æ®µéƒ½ä¸åŒ
3. å­ç±»æ²¡æœ‰æ— å‚æ„é€ å‡½æ•°ï¼Œæ²¡æœ‰Serializableåºåˆ—åŒ–æ¥å£

![image-20250904215817845](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904215817845.png)



ä¸ºäº†é¿å…ä¸å¿…è¦çš„æŠ¥é”™ï¼Œä½¿ç”¨é«˜æ€§èƒ½çš„[kryoåºåˆ—åŒ–åº“](https://github.com/EsotericSoftware/kryo)

(1)å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.esotericsoftware</groupId>
    <artifactId>kryo</artifactId>
    <version>5.6.2</version>
</dependency>
```

ï¼ˆ2ï¼‰åœ¨æ ¹åŒ…ä¸‹æ–°å¢chatmemoryåŒ…ï¼Œç¼–å†™FileBasedChatMemory

```java
package com.yupi.yuaiagent.chatmemory;

import com.esotericsoftware.kryo.Kryo;
import com.esotericsoftware.kryo.io.Input;
import com.esotericsoftware.kryo.io.Output;
import org.objenesis.strategy.StdInstantiatorStrategy;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.messages.Message;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

/**
 * åŸºäºæ–‡ä»¶æŒä¹…åŒ–çš„å¯¹è¯è®°å¿†
 */
public class FileBasedChatMemory implements ChatMemory {

    private final String BASE_DIR;
    private static final Kryo kryo = new Kryo();

    static {
        kryo.setRegistrationRequired(false);
        // è®¾ç½®å®ä¾‹åŒ–ç­–ç•¥
        kryo.setInstantiatorStrategy(new StdInstantiatorStrategy());
    }

    // æ„é€ å¯¹è±¡æ—¶ï¼ŒæŒ‡å®šæ–‡ä»¶ä¿å­˜ç›®å½•
    public FileBasedChatMemory(String dir) {
        this.BASE_DIR = dir;
        File baseDir = new File(dir);
        if (!baseDir.exists()) {
            baseDir.mkdirs();
        }
    }

    @Override
    public void add(String conversationId, List<Message> messages) {
        List<Message> conversationMessages = getOrCreateConversation(conversationId);
        conversationMessages.addAll(messages);
        saveConversation(conversationId, conversationMessages);
    }

    @Override
    public List<Message> get(String conversationId) {
        return getOrCreateConversation(conversationId);
    }

    @Override
    public void clear(String conversationId) {
        File file = getConversationFile(conversationId);
        if (file.exists()) {
            file.delete();
        }
    }

    private List<Message> getOrCreateConversation(String conversationId) {
        File file = getConversationFile(conversationId);
        List<Message> messages = new ArrayList<>();
        if (file.exists()) {
            try (Input input = new Input(new FileInputStream(file))) {
                messages = kryo.readObject(input, ArrayList.class);
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return messages;
    }

    private void saveConversation(String conversationId, List<Message> messages) {
        File file = getConversationFile(conversationId);
        try (Output output = new Output(new FileOutputStream(file))) {
            kryo.writeObject(output, messages);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private File getConversationFile(String conversationId) {
        return new File(BASE_DIR, conversationId + ".kryo");
    }
}

```



ï¼ˆ3ï¼‰ä¿®æ”¹LoveAppçš„æ„é€ å‡½æ•°

```java
/**
     * åˆå§‹åŒ– ChatClient
     *
     * @param dashscopeChatModel
     */
    public LoveApp(ChatModel dashscopeChatModel) {
//        // åˆå§‹åŒ–åŸºäºæ–‡ä»¶çš„å¯¹è¯è®°å¿†
        String fileDir = System.getProperty("user.dir") + "/tmp/chat-memory";
        ChatMemory chatMemory = new FileBasedChatMemory(fileDir);
        // åˆå§‹åŒ–åŸºäºå†…å­˜çš„å¯¹è¯è®°å¿†
//        MessageWindowChatMemory chatMemory = MessageWindowChatMemory.builder()
//                .chatMemoryRepository(new InMemoryChatMemoryRepository())
//                .maxMessages(20)
//                .build();
        chatClient = ChatClient.builder(dashscopeChatModel)
                .defaultSystem(SYSTEM_PROMPT)
                .defaultAdvisors(
                        MessageChatMemoryAdvisor.builder(chatMemory).build(),
                        // è‡ªå®šä¹‰æ—¥å¿— Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                        new MyLoggerAdvisor()
//                        // è‡ªå®šä¹‰æ¨ç†å¢å¼º Advisorï¼Œå¯æŒ‰éœ€å¼€å¯
                       ,new ReReadingAdvisor()
                )
                .build();
    }
```

ï¼ˆ4ï¼‰æµ‹è¯•

![image-20250904220724029](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904220724029.png)



### Spring AI Prompt æ¨¡æ¿ç‰¹æ€§

[Prompts :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/prompt.html#_prompttemplate)

Spring AIä¸­ç”¨äºæ„å»ºå’Œç®¡ç†æç¤ºè¯çš„æ ¸å¿ƒç»„ä»¶ã€‚å…è®¸å¼€å‘è€…åˆ›å»ºå¸¦æœ‰å ä½ç¬¦çš„æ–‡æœ¬æ¨¡æ¿ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€æ›¿æ¢



åŸºæœ¬åŠŸèƒ½æ”¯æŒå˜é‡æ›¿æ¢

```java
// å®šä¹‰å¸¦æœ‰å˜é‡çš„æ¨¡æ¿
String template = "ä½ å¥½ï¼Œ{name}ã€‚ä»Šå¤©æ˜¯{day}ï¼Œå¤©æ°”{weather}ã€‚";

// åˆ›å»ºæ¨¡æ¿å¯¹è±¡
PromptTemplate promptTemplate = new PromptTemplate(template);

// å‡†å¤‡å˜é‡æ˜ å°„
Map<String, Object> variables = new HashMap<>();
variables.put("name", "é±¼çš®");
variables.put("day", "æ˜ŸæœŸä¸€");
variables.put("weather", "æ™´æœ—");

// ç”Ÿæˆæœ€ç»ˆæç¤ºæ–‡æœ¬
String prompt = promptTemplate.render(variables);
// ç»“æœ: "ä½ å¥½ï¼Œé±¼çš®ã€‚ä»Šå¤©æ˜¯æ˜ŸæœŸä¸€ï¼Œå¤©æ°”æ™´æœ—ã€‚"
```

#### å®ç°åŸç†

ä½¿ç”¨OSS StringTemplateæ¨¡æ¿å¼•æ“

```java
public class PromptTemplate implements PromptTemplateActions, PromptTemplateMessageActions {
    // å®ç°ç»†èŠ‚
}
```

![image-20250904221419258](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904221419258.png)



#### ä¸“ç”¨æ¨¡æ¿ç±»

SystemPromptTemplateï¼šç³»ç»Ÿæ¶ˆæ¯ï¼Œè®¾ç½®AIçš„è¡Œä¸ºå’ŒèƒŒæ™¯

AssistantPromptTemplateï¼šåŠ©æ‰‹æ¶ˆæ¯ï¼Œè®¾ç½®AIå›å¤çš„ç»“æ„

FunctionPromptTemplateï¼šç›®å‰æ²¡ç”¨

![image-20250904221619756](https://note-1259190304.cos.ap-chengdu.myqcloud.com/noteimage-20250904221619756.png)

```java
String userTextâ€ = """
    Tell me about threeï»¿ famous pirates from the Goldeâ€‹n Age of Piracy and why they dâ€‹id.
    Write at least a senteâ¡nce for each pirate.
    """;

Message userMessage = new UserMessage(userText);

String syâ€stemText = """
  ï»¿You are a helpfulâ€‹ AI assistant thaâ€‹t helps people fiâ¡nd information.
  Your name is {name}
  You should reply to the user's request with your name and also in the style of a {voice}.
  """;

SystemPromptTemplate systemPromptTemplate = new SystemPromptTemplate(systemText);
Message systemMessage = systemPromptTemplate.createMessage(Map.of("name", name, "voice", voice));

Prompt prompt = new Prompt(List.of(userMessage, systemMessage));

List<Generation> response = chatModel.call(prompt).getResults();
```

#### ä»æ–‡ä»¶åŠ è½½æ¨¡æ¿

```java
// ä»ç±»è·¯å¾„èµ„æºåŠ è½½ç³»ç»Ÿæç¤ºæ¨¡æ¿
@Value("classpath:/prompts/system-message.st")
private Resource systemResource;

// ç›´æ¥ä½¿ç”¨èµ„æºåˆ›å»ºæ¨¡æ¿
SystemPromptTemplate systemPromptTemplate = new SystemPromptTemplate(systemResource);
```



### å¤šæ¨¡æ€æ¦‚å¿µå’Œå¼€å‘

[Multimodality API :: Spring AI Reference](https://docs.spring.io/spring-ai/reference/api/multimodality.html)

èƒ½å¤ŸåŒæ—¶å¤„ç†ã€ç†è§£å’Œç”Ÿæˆå¤šç§ä¸åŒç±»å‹æ•°æ®çš„èƒ½åŠ›ï¼Œå¦‚æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ã€PDFã€ç»“æ„åŒ–æ•°æ®ã€‚



å…è®¸å‘é€åŒ…å«å›¾ç‰‡

```java
byte[] data = new ClassPathResource("/vertex-test.png").getContentAsByteArray();

var userMessage = new UserMessage("Explain what do you see on this picture?",
        List.of(new Media(MimeTypeUtils.IMAGE_PNG, this.data)));

ChatResponse response = chatModel.call(new Prompt(List.of(this.userMessage)));
```

ChatClient API æ·»åŠ èµ„æº

```java
String response = ChatClient.create(chatModel).prompt()
		.user(u -> u.text("Explain what do you see on this picture?")
				    .media(MimeTypeUtils.IMAGE_PNG, new ClassPathResource("/multimodal.test.png")))
		.call()
		.content();
```



[é€šä¹‰åƒé—®APIå‚è€ƒ_å¤§æ¨¡å‹æœåŠ¡å¹³å°ç™¾ç‚¼(Model Studio)-é˜¿é‡Œäº‘å¸®åŠ©ä¸­å¿ƒ](https://help.aliyun.com/zh/model-studio/use-qwen-by-calling-api#d0e30636ad3s3)



## RAG çŸ¥è¯†åº“åŸºç¡€

### AI Javaå¼€å‘çŸ¥è¯†é—®ç­”éœ€æ±‚åˆ†æ

### RAG æ¦‚å¿µï¼ˆé‡ç‚¹ç†è§£æ ¸å¿ƒæ­¥éª¤ï¼‰

### RAG å®æˆ˜ï¼šSpring AI + æœ¬åœ°çŸ¥è¯†åº“

### RAG å®æˆ˜ï¼šSpring AI + äº‘çŸ¥è¯†åº“æœåŠ¡

## RAG çŸ¥è¯†åº“è¿›é˜¶

### RAG æ ¸å¿ƒç‰¹æ€§

#### æ–‡æ¡£æ”¶é›†å’Œåˆ‡å‰²ï¼ˆETLï¼‰

#### å‘é‡è½¬æ¢å’Œå­˜å‚¨ï¼ˆå‘é‡æ•°æ®åº“ï¼‰

#### æ–‡æ¡£è¿‡æ»¤å’Œæ£€ç´¢ï¼ˆæ–‡æ¡£æ£€ç´¢å™¨ï¼‰

#### æŸ¥è¯¢å¢å¼ºå’Œå…³è”ï¼ˆä¸Šä¸‹æ–‡æŸ¥è¯¢å¢å¼ºå™¨ï¼‰

### RAG æœ€ä½³å®è·µå’Œè°ƒä¼˜

### æ£€ç´¢ç­–ç•¥

### å¤§æ¨¡å‹å¹»è§‰

## å·¥å…·è°ƒç”¨

### å·¥å…·æ¦‚å¿µ

#### Spring AI å·¥å…·å¼€å‘

#### ä¸»æµå·¥å…·å¼€å‘

##### æ–‡ä»¶æ“ä½œ

##### è”ç½‘æœç´¢

##### ç½‘é¡µæŠ“å–

##### ç»ˆç«¯æ“ä½œ

##### èµ„æºä¸‹è½½

##### PDF ç”Ÿæˆ

#### å·¥å…·è¿›é˜¶çŸ¥è¯†ï¼ˆåŸç†å’Œé«˜çº§ç‰¹æ€§ï¼‰

## MCP

### MCP æ¦‚å¿µ

### ä½¿ç”¨ MCPï¼ˆ3 ç§æ–¹å¼ï¼‰

### Spring AI MCP å¼€å‘æ¨¡å¼

### Spring AI MCP å¼€å‘å®æˆ˜ - å›¾ç‰‡æœç´¢ MCP

### MCP å¼€å‘æœ€ä½³å®è·µ

### éƒ¨ç½² MCP

### MCP å®‰å…¨é—®é¢˜

## AI æ™ºèƒ½ä½“æ„å»º

### AI æ™ºèƒ½ä½“æ¦‚å¿µ

### æ™ºèƒ½ä½“å®ç°å…³é”®

### ä½¿ç”¨ AI æ™ºèƒ½ä½“ï¼ˆ2 ç§æ–¹å¼ï¼‰

### è‡ªä¸»è§„åˆ’æ™ºèƒ½ä½“ä»‹ç»

### OpenManus å®ç°åŸç†

### è‡ªä¸»å®ç° Manus æ™ºèƒ½ä½“

### æ™ºèƒ½ä½“å·¥ä½œæµ

## AI æœåŠ¡åŒ–

### AI åº”ç”¨æ¥å£å¼€å‘ï¼ˆSSEï¼‰

### AI æ™ºèƒ½ä½“æ¥å£å¼€å‘

### AI ç”Ÿæˆå‰ç«¯ä»£ç 

### AI æœåŠ¡ Serverless éƒ¨